<!DOCTYPE html>
<html>
<head>
  <title>Animal Manager | ç·¨è¼¯è³‡æ–™</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/format.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
  <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #009688; color: white; }
    td[contenteditable="true"] { background-color: #f9f9f9; }
    .action-btn { cursor: pointer; color: red; font-weight: bold; }
  </style>
</head>
<body class="w3-theme-l5">

  <div class="w3-container w3-teal">
    <h2>ç·¨è¼¯è³‡æ–™åº«</h2>
  </div>
  <a href="/AnimalManager/gene" class="w3-button" style="background-color: #b3b3b3;">â¬… è¿”å›åŸºå› è³‡æ–™åº«</a>

  <div class="w3-container w3-padding-32">
    <div style="margin-bottom:10px; display: flex; align-items: center; gap: 20px;">
      <label for="collectionSelect" style="margin-right:10px;">è³‡æ–™é›†ï¼š</label>
      <select id="collectionSelect" class="w3-select" style="width:300px; height: 45px;" onchange="changeCollection()"></select>
      <button class="w3-button" style="background-color: rgb(237, 228, 100); margin-left: 20px; height: 45px;" onclick="addRow()">â• æ–°å¢è³‡æ–™</button>
    </div>

    <!-- è³‡æ–™è¡¨ -->
    <div style="overflow-x:auto;">
      <table id="editTable">
        <thead id="editTableHeader"></thead>
        <tbody id="editTableBody"></tbody>
      </table>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div">
      <button class="w3-button w3-teal" onclick="saveChanges()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>

      <!-- é ç¢¼ -->
      <div id="paginationControls" style="text-align: center;"></div>
    </div>
  </div>

<script>
let currentCollection = null;
let tableData = [];
let columns = [];
let currentPage = 1;
const rowsPerPage = 10; // æ¯é  10 ç­†
let deletedRows = [];   // å„²å­˜è¢«åˆªæ‰çš„ _id

// åˆå§‹åŒ–
window.onload = function() {
  loadCollections();
  const urlParams = new URLSearchParams(window.location.search);
  const collectionName = urlParams.get("collection");
  if (collectionName) {
    document.getElementById("collectionSelect").value = collectionName;
    loadCollectionData(collectionName);
  }
}

// è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™é›†
async function loadCollections() {
  const token = localStorage.getItem("userToken");
  if (!token) { alert("è«‹å…ˆç™»å…¥"); return; }

  const res = await fetch("/gene/collections", { headers: { "Authorization": "Bearer " + token } });
  if (!res.ok) { alert("ç„¡æ³•è¼‰å…¥è³‡æ–™é›†"); return; }

  const collections = await res.json();
  const select = document.getElementById("collectionSelect");
  select.innerHTML = "<option value='' disabled selected>è«‹é¸æ“‡è³‡æ–™é›†</option>"; 
  collections.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
}

// åˆ‡æ›è³‡æ–™é›†
function changeCollection() {
  const select = document.getElementById("collectionSelect");
  const collectionName = select.value;
  if (collectionName) loadCollectionData(collectionName);
}

// è¼‰å…¥è³‡æ–™é›†å…§å®¹
async function loadCollectionData(collectionName) {
  const token = localStorage.getItem("userToken");
  if (!token) { alert("è«‹å…ˆç™»å…¥"); return; }

  try {
    const res = await fetch(`/gene/data/${collectionName}`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) { alert("ç„¡æ³•è¼‰å…¥è³‡æ–™"); return; }

    const result = await res.json();
    currentCollection = collectionName;
    tableData = result.data || [];

    // å¦‚æœ fields æœ‰å€¼å°±ç”¨ï¼Œæ²’æœ‰å°±è‡ªå‹•æŠ“è³‡æ–™ç¬¬ä¸€ç­†æ¬„ä½ï¼Œæ’é™¤ _id å’Œ user_id
    if (result.fields && result.fields.length > 0) {
      columns = result.fields;
    } else if (tableData.length > 0) {
      columns = Object.keys(tableData[0]).filter(f => f !== "_id" && f !== "user_id");
    } else {
      columns = [];
    }

    currentPage = 1; // é è¨­å›åˆ°ç¬¬ä¸€é 

    // console.log("è¼‰å…¥è³‡æ–™é›†:", collectionName);
    // console.log("æ¬„ä½:", columns);
    // console.log("è³‡æ–™ç­†æ•¸:", tableData.length);

    renderTable();
  } catch (err) {
    console.error("è¼‰å…¥è³‡æ–™å¤±æ•—:", err);
    alert("è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  }
}

// æ¸²æŸ“è¡¨æ ¼
function renderTable() {
  const header = document.getElementById("editTableHeader");
  const body = document.getElementById("editTableBody");
  header.innerHTML = "";
  body.innerHTML = "";

  if (!columns.length) {
    header.innerHTML = "<tr><th>ï¼ˆç©ºè³‡æ–™é›†ï¼‰</th></tr>";
    return;
  }

  // è¡¨é ­
  const trHead = document.createElement("tr");
  columns.forEach(col => {
    const th = document.createElement("th");
    th.textContent = col;
    trHead.appendChild(th);
  });
  const thAction = document.createElement("th");
  thAction.textContent = "æ“ä½œ";
  trHead.appendChild(thAction);
  header.appendChild(trHead);

  // è¨ˆç®—åˆ†é ç¯„åœ
  const start = (currentPage - 1) * rowsPerPage;
  const end = Math.min(start + rowsPerPage, tableData.length);
  const pageData = tableData.slice(start, end);

  // è¡¨æ ¼å…§å®¹
  pageData.forEach((row, rowIndex) => {
    const tr = document.createElement("tr");
    columns.forEach(col => {
      const td = document.createElement("td");
      td.contentEditable = "true";
      td.textContent = row[col] ?? ""; // è‹¥æ¬„ä½å€¼ä¸å­˜åœ¨å‰‡é¡¯ç¤ºç©ºç™½
      td.style.cursor = "text";
      td.oninput = () => {
        tableData[start + rowIndex][col] = td.textContent;
        tableData[start + rowIndex]._modified = true;
        if (!tableData[start + rowIndex]._modifiedCols) tableData[start + rowIndex]._modifiedCols = [];
        if (!tableData[start + rowIndex]._modifiedCols.includes(col)) tableData[start + rowIndex]._modifiedCols.push(col);
        td.style.backgroundColor = "#fffae6"; // å·²ä¿®æ”¹æ¨™è¨˜
      };
      tr.appendChild(td);
    });

    const tdAction = document.createElement("td");
    tdAction.innerHTML = `<span class="action-btn" onclick="deleteRow(${start + rowIndex})">ğŸ—‘ï¸</span>`;
    tr.appendChild(tdAction);

    body.appendChild(tr);
  });

  renderPagination();
}

// æ¸²æŸ“åˆ†é æŒ‰éˆ•
function renderPagination() {
  const container = document.getElementById("paginationControls");
  if (!container) return;

  container.innerHTML = "";
  const totalPages = Math.ceil(tableData.length / rowsPerPage);
  if (totalPages <= 1) return;

  const makeBtn = (label, page, disabled) => {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.disabled = disabled;
    btn.className = "w3-button w3-border w3-small w3-margin";
    btn.onclick = () => { currentPage = page; renderTable(); };
    return btn;
  };

  container.appendChild(makeBtn("â®ï¸ ç¬¬ä¸€é ", 1, currentPage === 1));
  container.appendChild(makeBtn("â—€ï¸ ä¸Šä¸€é ", currentPage - 1, currentPage === 1));

  const pageSelect = document.createElement("select");
  for (let i = 1; i <= totalPages; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `ç¬¬ ${i} é `;
    if (i === currentPage) option.selected = true;
    pageSelect.appendChild(option);
  }
  pageSelect.onchange = () => {
    currentPage = Number(pageSelect.value);
    renderTable();
  };
  container.appendChild(pageSelect);

  container.appendChild(makeBtn("ä¸‹ä¸€é  â–¶ï¸", currentPage + 1, currentPage === totalPages));
  container.appendChild(makeBtn("æœ€å¾Œé  â­ï¸", totalPages, currentPage === totalPages));
}

// æ–°å¢ç©ºåˆ—
function addRow() {
  if (!columns.length) { alert("è«‹å…ˆé¸æ“‡è³‡æ–™é›†"); return; }
  const newRow = {};
  columns.forEach(c => newRow[c] = "");
  tableData.push(newRow);
  currentPage = Math.ceil(tableData.length / rowsPerPage); // è·³åˆ°æœ€å¾Œä¸€é 
  renderTable();

  // èšç„¦åˆ°æ–°å¢ç©ºåˆ—çš„ç¬¬ä¸€å€‹æ¬„ä½
  const tbody = document.getElementById("editTableBody");
  if (tbody.rows.length > 0) {
    const firstCell = tbody.rows[tbody.rows.length - 1].cells[0];
    if (firstCell) firstCell.focus();
  }
}

// åˆªé™¤åˆ—
async function deleteRow(index) {
  const row = tableData[index];
  if (row._id) {
    deletedRows.push(row._id); // å„²å­˜å¾…åˆªé™¤
  }
  tableData.splice(index, 1);
  renderTable();
}

// å„²å­˜ä¿®æ”¹
async function saveChanges() {
  if (!currentCollection) { alert("è«‹å…ˆé¸æ“‡è³‡æ–™é›†"); return; }
  const token = localStorage.getItem("userToken");
  if (!token) { alert("è«‹å…ˆç™»å…¥"); return; }

  // å…ˆç¢ºèªæ˜¯å¦è¦å­˜æª”
  const changedRows = tableData.filter(row => row._modified || !row._id);
  if (deletedRows.length === 0 && changedRows.length === 0) {
    alert("æ²’æœ‰ä»»ä½•è®Šæ›´éœ€è¦å„²å­˜");
    return;
  }

  // å»ºç«‹ä¿®æ”¹æ‘˜è¦
  let summary = "";
  if (deletedRows.length > 0) summary += `åˆªé™¤: ${deletedRows.length} ç­†\n`;
  if (changedRows.length > 0) {
    summary += "ä¿®æ”¹/æ–°å¢è³‡æ–™:\n";
    changedRows.forEach((row, idx) => {
      const changedCols = Object.keys(row).filter(k => row._modifiedCols && row._modifiedCols.includes(k));
      if (changedCols.length > 0 || !row._id) {
        summary += `ç¬¬ ${idx + 1} åˆ—ä¿®æ”¹æ¬„ä½: ${changedCols.join(", ")}\n`;
      }
    });
  }

  const confirmSave = confirm(`æ‚¨ç¢ºå®šè¦å„²å­˜å—ï¼Ÿ`);
  if (!confirmSave) return;

  let successCount = 0;
  let failCount = 0;
  let deleteSuccess = 0;
  let deleteFail = 0;

  // å…ˆè™•ç†åˆªé™¤
  for (let id of deletedRows) {
    try {
      const res = await fetch(`/gene/delete/${currentCollection}/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) throw new Error(await res.text());
      deleteSuccess++;
    } catch (err) {
      console.error("åˆªé™¤å¤±æ•—:", id, err);
      deleteFail++;
    }
  }
  deletedRows = [];

  // è™•ç†ä¿®æ”¹/æ–°å¢
  for (let row of changedRows) {
    try {
      const payload = { ...row };
      delete payload._id;
      delete payload._modified;
      delete payload._modifiedCols;

      if (row._id) {
        // æ›´æ–°
        const res = await fetch(`/gene/update/${currentCollection}/${row._id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify(payload)
        });
        const result = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(result.detail || res.statusText);
      } else {
        // æ–°å¢
        const res = await fetch(`/gene/manual_add/${currentCollection}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify(payload)
        });
        const result = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(result.detail || res.statusText);
      }
      successCount++;
    } catch (err) {
      console.error("å„²å­˜å¤±æ•—çš„è³‡æ–™åˆ—:", row, err);
      failCount++;
    }
  }

  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  if (successCount + deleteSuccess > 0) {
    alert(`${currentCollection} æ›´æ–°æˆåŠŸ\nåˆªé™¤æˆåŠŸ: ${deleteSuccess} ç­†\nä¿®æ”¹/æ–°å¢æˆåŠŸ: ${successCount} ç­†`);
  } else if (failCount + deleteFail > 0) {
    alert(`${currentCollection} æ›´æ–°å¤±æ•—\nåˆªé™¤å¤±æ•—: ${deleteFail} ç­†\nä¿®æ”¹/æ–°å¢å¤±æ•—: ${failCount} ç­†`);
  }

  await loadCollectionData(currentCollection); // é‡æ–°è¼‰å…¥è³‡æ–™
}
</script>

</body>
</html>