<!DOCTYPE html>
<html>
<head>
  <title>Animal Manager | 基因篩選</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/predict.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
  <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="../static/js/auth.js"></script>

  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/series-label.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script src="https://code.highcharts.com/themes/adaptive.js"></script>
</head>

<body id="myPage">
  <script>
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;

      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      tablinks = document.getElementsByClassName("tablink");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" w3-teal", "");
      }

      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " w3-teal";
    }
  </script>

  <!-- Navbar -->
  <div class="w3-top">
  <div class="w3-bar w3-theme-d2 w3-left-align w3-xlarge">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-hover-white w3-theme-d2" href="javascript:void(0);" onclick="openNav()"><i class="fa fa-bars"></i></a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager')" class="w3-bar-item w3-button"><i class="fa fa-home w3-margin-right"></i>HOME</a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager/myfarm')" class="w3-bar-item w3-button w3-hide-small w3-hover-white" id="role">我的牧場</a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager/predict')" class="w3-bar-item w3-button w3-hide-small w3-hover-white" id="growthBtn">成長預測</a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager/gene')" class="w3-bar-item w3-button w3-hide-small w3-hover-white" id="geneBtn">基因資料庫</a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager/genePredict')" class="w3-bar-item w3-button w3-hide-small w3-hover-white w3-teal" id="genePredictBtn">基因篩選</a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager/history')" class="w3-bar-item w3-button w3-hide-small w3-hover-white">歷史預測紀錄</a>
    <a href="#" onclick="checkLoginAndRedirect('/AnimalManager/search')" class="w3-bar-item w3-button w3-hide-small w3-right w3-hover-teal" title="Search"><i class="fa fa-search"></i></a>
    <div class="w3-container w3-right" id="authButtons">  
      <button onclick="document.getElementById('id01').style.display='block'" class="w3-button w3-theme w3-hover-teal" title="登入/註冊">登入/註冊</button>
    </div>
  </div>

  <!-- Navbar on small screens -->
    <div id="navDemo" class="w3-bar-block w3-theme-d2 w3-hide w3-hide-large w3-hide-medium">
      <a href="/AnimalManager/gene" class="w3-bar-item w3-button">基因資料庫</a>
      <a href="/AnimalManager/genePredict" class="w3-bar-item w3-button">基因預測</a>
      <div class="w3-container">  
        <button onclick="openSignupTab()" class="w3-button w3-theme w3-hover-teal">登入/註冊</button>
      </div>
      <a href="/AnimalManager/search" class="w3-bar-item w3-button">Search</a>
    </div>
  </div>

  <!-- Log in / Sign up Modal -->
  <div id="id01" class="w3-modal">
    <div class="w3-modal-content w3-card-4 w3-animate-top" style="width: 500px;">
      <header class="w3-container w3-teal w3-display-container">
        <span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-teal w3-display-topright">
          <i class="fa fa-remove"></i>
        </span>
      </header>

      <!-- Tab buttons -->
      <div class="w3-bar w3-light-grey">
        <button class="w3-bar-item w3-button tablink w3-teal" onclick="openTab(event, 'LoginForm')">登入</button>
        <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'SignupForm')">註冊</button>
      </div>

      <!-- 登入表單 -->
      <form id="LoginForm" class="tabcontent" onsubmit="loginUser(event)">
        <div class="w3-container" style="padding: 20px;">
          <label for="login_mail">Email</label>
          <input type="email" id="login_mail" class="w3-input w3-border" placeholder="Email"><br>
          <label for="login_pw">Password</label>
          <input type="password" id="login_pw" class="w3-input w3-border" placeholder="Password"><br>
          <a onclick="document.getElementById('id03').style.display='block'" style="cursor: pointer; color: #009688;">忘記密碼</a><br><br>
          <div style="text-align: center;">
            <button type="submit" class="w3-button w3-theme">登入</button>
          </div>
        </div>
      </form>

      <!-- 註冊表單 -->
      <form id="SignupForm" class="tabcontent" style="display:none;" onsubmit="registerUser(event)">
        <div class="w3-container" style="padding: 20px;">
          <label for="signup_FarmName">牧場名稱 / 研究員名稱</label>
          <input type="text" id="signup_FarmName" class="w3-input w3-border" placeholder="牧場名稱 / 研究員名稱"><br><br>
          <label for="signup_mail">Email</label>
          <input type="email" id="signup_mail" class="w3-input w3-border" placeholder="Email"><br>
          <label for="signup_pw">Password</label>
          <input type="password" id="signup_pw" class="w3-input w3-border" placeholder="Password"><br><br>
          <label for="userRole">身分</label>
          <select id="userRole" class="w3-select w3-border">
            <option value="Farmer" selected>牧場主</option>
            <option value="GeneticResearcher">基因研究者</option>
          </select><br><br>
          <div style="text-align: center;">
            <button type="submit" class="w3-button w3-theme">註冊</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 忘記密碼 -->
  <div id="id03" class="w3-modal" style="display:none;">
    <div class="w3-modal-content w3-card-4 w3-animate-top" style="width:500px;">
      <header class="w3-container w3-teal"> 
        <span onclick="closeModal()" class="w3-button w3-display-topright">&times;</span>
        <h4 style="text-align:center;">忘記密碼</h4>
      </header>
      <div class="w3-container" style="padding:20px;">
        <label>Email</label><br>
        <input type="email" id="resetEmail" class="w3-input w3-border" placeholder="輸入Email"><br>
        <button class="w3-button w3-teal" onclick="sendCode()">發送驗證碼</button>

        <div id="verifySection" style="display:none; padding-top:20px;">
          <label>驗證碼</label><br>
          <input type="text" id="codeInput" class="w3-input w3-border" placeholder="輸入驗證碼"><br>
          <span id="codeError" class="w3-text-red" style="display:none;">驗證碼錯誤或過期</span><br>
          <button class="w3-button w3-teal" onclick="verifyCode()">驗證</button>
        </div>

        <form id="resetForm" style="display:none; padding-top:20px;">
          <label>新密碼</label><br>
          <input type="password" id="newPw" class="w3-input w3-border" placeholder="輸入新密碼"><br>
          <label>確認新密碼</label><br>
          <input type="password" id="confirmPw" class="w3-input w3-border" placeholder="再次輸入新密碼"><br><br>
          <button type="submit" class="w3-button w3-teal">設定新密碼</button>
        </form>
      </div>
    </div>
  </div>

  <div class="w3-container w3-padding-64 w3-theme-l5" id="myfarm">
    <div class="w3-row">
      <div class="w3-col m12">
        <div class="w3-padding-16" style="margin-bottom: 10px;">
          <span class="w3-border-teal w3-bottombar" style="font-size: 30px;">基因篩選</span>
        </div>
          <!-- CSV 上傳區 -->
        <div class="w3-margin-top">
          <input class="w3-input w3-border" type="file" id="csvFile" accept=".csv">
          <button class="w3-button w3-teal w3-margin-top" onclick="uploadCSV()">上傳 CSV</button>
        </div>
        <div id="result"></div>
        <div id="volcanoChart" style="width:100%; height:350px; margin-top:20px;"></div>
      </div>
    </div>
  </div>


  <!-- Footer -->
  <footer class="w3-container w3-padding-32 w3-theme w3-center">
    <h4>Follow Us</h4>
    <a class="w3-button w3-large w3-teal" href="javascript:void(0)" title="Facebook"><i class="fa fa-facebook"></i></a>
    <a class="w3-button w3-large w3-teal" href="javascript:void(0)" title="Twitter"><i class="fa fa-twitter"></i></a>
    <a class="w3-button w3-large w3-teal" href="javascript:void(0)" title="Google +"><i class="fa fa-google-plus"></i></a>
    <a class="w3-button w3-large w3-teal" href="javascript:void(0)" title="Google +"><i class="fa fa-instagram"></i></a>
    <a class="w3-button w3-large w3-teal w3-hide-small" href="javascript:void(0)" title="Linkedin"><i class="fa fa-linkedin"></i></a>
    <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>

    <div style="position:relative;bottom:100px;z-index:1;" class="w3-tooltip w3-right">
      <span class="w3-text w3-padding w3-teal w3-hide-small">Go To Top</span>   
      <a class="w3-button w3-theme" href="#myPage"><span class="w3-xlarge">
      <i class="fa fa-chevron-circle-up"></i></span></a>
    </div>
  </footer>

  <!-- 忘記密碼 -->
  <script src="/static/js/ForgotPW.js"></script>

  <!-- 使用者登入狀態 -->
  <script src="/static/js/localStorage.js"></script>

  <!-- 新增資料 -->
  <script src="/static/js/addCollection.js"></script>

  <!-- Predict -->
  <script src="/static/js/genePredict.js"></script>

  <!-- <script>
  function uploadCSV() {
    const fileInput = document.getElementById('csvFile');
    const token = localStorage.getItem("userToken");
    const file = fileInput.files[0];
    
    if (!file) {
      alert('請先選擇一個 CSV 檔案');
      return;
    }

    if (file.type !== "text/csv" && !file.name.endsWith(".csv")) {
      alert('只能上傳 CSV 檔案');
      return;
    }

    // 準備 FormData
    let formData = new FormData();
    formData.append("file", file);
    document.getElementById("result").innerHTML = "<p>分析中，請稍候...</p>";

    // 發送到後端 Flask
    fetch(`/genePredict?ts=${Date.now()}`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      // 把 top_genes 轉成表格列
      let rows = data.top_genes
        .map(item => `<tr><td>${item.gene}</td><td>${item.score}</td></tr>`)
        .join("");

      let tableHtml = `
        <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; margin-top: 5px;">
          <thead>
            <tr style="background-color: #f0f0f0;">
              <th>Gene</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      document.getElementById("result").innerHTML = `
        <h4>分析完成</h4>
        <p>檔案 : ${file.name}</p>
        <p>顯著基因數: ${data.sig_gene_count}</p>
        <p>前 10 個顯著基因與分數:</p>
        ${tableHtml}
        <img src="data:image/png;base64,${data.volcano_plot}" width="500">
      `;

      fileInput.value = ""; // 清空 file input
    })

    .catch(error => {
      document.getElementById("result").innerHTML = "<p>上傳失敗，請重試。</p>";
      console.error("上傳錯誤:", error);
    });
  }
  </script> -->
</body>
</html>